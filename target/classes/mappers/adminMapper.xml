<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="admin">

<select id="selectAdminList" resultType="userinfo">
	select id, password, name, nickname, to_char(birth,'yyyy-mm-dd') birth, email, tel, addr, auth, profile, secure, secure_ans,
		 to_char(regdate,'yyyy-mm-dd hh24:mi:ss') regdate, to_char(updatedate,'yyyy-mm-dd hh24:mi:ss') updatedate,
		 (select count(*) from tbl_boards where id = userinfos.id) myBoards, (select count(*) from tbl_replies where id = userinfos.id) replyCount
		from userinfos 
		where auth = 2
		order by regdate desc
</select>

<select id="selectMemberList" resultType="userinfo">
	select userinfos.id, password, name, nickname, to_char(birth,'yyyy-mm-dd') birth, email, tel, addr, auth, profile, secure, secure_ans,
		 to_char(regdate,'yyyy-mm-dd hh24:mi:ss') regdate, to_char(updatedate,'yyyy-mm-dd hh24:mi:ss') updatedate,
		 (select count(*) from tbl_boards where id = userinfos.id) myBoards, (select count(*) from tbl_replies where id = userinfos.id) replyCount,state
		from userinfos INNER JOIN userstate on userinfos.id = userstate.ID
		where auth != 2
		
		<include refid="search"/>
		
		order by regdate desc
</select>

<select id="selectMemberCount" resultType="int">
	select count(*) from userinfos where auth != 2
	<include refid="search"/>
</select>

<update id="upgrade">
	update userinfos set auth= auth + 2 where id = #{id}
</update>

<update id="downgrade">
	update userinfos set auth= auth - 2 where id = #{id}
</update>

	<sql id="search">
	<if test="searchType != null">
		<if test="searchType == 'n'.toString()">
			and name like '%'||#{keyword}||'%'
		</if>
		<if test="searchType == 't'.toString()">
			and id like '%'||#{keyword}||'%'
		</if>
	</if>
	</sql>
	
											<!-- ######################################### -->
														<!-- 게시판 현황 가져오기-->
											<!-- ######################################### -->
	
	<!-- 카테고리 cname,cno, cno별로 DB개수 출력-->
	<select id="selectBoardsCount" resultType="boardsCount">
		select cname,cno,(select count(*) from tbl_boards where cno = a.cno) count 
		from tbl_category a 
		order by count desc
		
	</select>
	
	<!-- cno의 DB개수 -->
	<select id="categoryDetail" resultType="boardVO">
		select do1, si, place1, place2, tbno,(select cname from tbl_category where cno = b.cno) cname,
		(select csname from tbl_subcategory where csno= b.csno) csname, title,
		id, (select nickname from userinfos where id = b.id) nickname, regdate, viewcnt 
		from tbl_boards b
		where cno= #{cno}
		<include refid="search2"/>
		order by regdate desc, do1, csno
	</select>
	
	<select id="categoryDetailCount" resultType="int">
		select count(*) from (
			select do1, si, place1, place2, tbno,(select csname from tbl_subcategory where csno= b.csno) csname, title,
			id, (select nickname from userinfos where id = b.id) nickname, regdate, viewcnt 
			from tbl_boards b
			where cno= #{cno}
			<include refid="search2"/>
		)
	</select>
	
	<select id="selectCnoList" resultType="java.util.Map">
		select do1, count(*) count from tbl_boards
			where cno = #{cno}		
		<if test="place1 != null">
			and place1 like #{place1} <!-- and place2 like #{place2} -->
		</if>
		group by do1 
		order by count desc, do1
	</select>
	
	<select id="selectCityList" resultType="java.util.Map">
		select si, dong, count(*) count from tbl_boards 
		where do1 like #{do1} and cno = #{cno}
		<if test="place1 neq ''">
			and place1 like #{place1}
		</if>
		group by si,dong 
		order by count desc, si
	</select>
	
		<sql id="search2">
	<if test="searchType != null">
		
		<if test="searchType == 'd'.toString()">
			and do1 like '%'||#{keyword}||'%'
		</if>
		<if test="searchType == 's'.toString()">
			and si like '%'||#{keyword}||'%'
		</if>
		<if test="searchType == 'p1'.toString()">
			and place1 like '%'||#{keyword}||'%'
		</if>
		<if test="searchType == 'p2'.toString()">
			and place2 like '%'||#{keyword}||'%'
		</if>
		<if test="searchType == 'k'.toString()">
			and csname like '%'||#{keyword}||'%'
		</if>
	</if>
	</sql>
	

</mapper>